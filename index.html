<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Terminal Payment — Login</title>

<style>
  :root{
    --yellow: #FFD400;
    --dark-yellow: #E6BB00;
    --bg: #ffffff;
    --text: #111;
    --card: #fff9e6;
    --btn-text: #111;
  }
  @media (prefers-color-scheme: dark) {
    :root{
      --bg: #000000;
      --text: #ffffff;
      --card: #0a0a0a;
      --yellow: #FFD400;
      --dark-yellow: #E6BB00;
      --btn-text: #000000;
    }
  }

  html,body{
    height:100%;
    margin:0;
    font-family: Inter, Roboto, Arial, sans-serif;
    background: linear-gradient(180deg, var(--bg), var(--bg));
    color:var(--text);
  }

  .wrap{
    max-width:760px;
    margin:40px auto;
    padding:24px;
  }

  .card{
    background:var(--card);
    border-radius:12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    padding:20px;
  }

  h1{ margin:0 0 12px 0; font-size:20px }
  p.lead{ margin:0 0 18px 0; color:rgba(0,0,0,0.6) }

  label{ display:block; margin-top:12px; font-size:13px; color:var(--text) }
  input[type="text"], input[type="password"], input[type="number"]{
    width:100%;
    padding:10px 12px;
    margin-top:6px;
    border-radius:8px;
    border:1px solid rgba(0,0,0,0.08);
    background: transparent;
    color:var(--text);
    box-sizing:border-box;
  }

  .row{ display:flex; gap:12px; margin-top:12px; }
  .col{ flex:1; }

  button.primary{
    display:inline-block;
    margin-top:16px;
    padding:12px 18px;
    border-radius:10px;
    border: none;
    background: linear-gradient(180deg,var(--yellow), var(--dark-yellow));
    color: var(--btn-text);
    font-weight:600;
    cursor:pointer;
    box-shadow: 0 6px 14px rgba(0,0,0,0.12);
  }
  button.ghost{
    margin-left:12px;
    background:transparent;
    color:var(--text);
    border:1px solid rgba(0,0,0,0.08);
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
  }

  .status{ margin-top:14px; font-size:14px; color:var(--text) }

  .qr-wrap{
    margin-top:18px;
    display:flex;
    gap:16px;
    align-items:center;
    justify-content:space-between;
  }
  .qr{
    width:220px;
    height:220px;
    border-radius:12px;
    background:white;
    display:flex;
    align-items:center;
    justify-content:center;
    border: 2px dashed rgba(0,0,0,0.06);
  }
  .qr img{ width:100%; height:100%; object-fit:cover; border-radius:8px; }

  .small{ font-size:13px; color:rgba(0,0,0,0.6) }

  @media (max-width:600px){
    .qr{ width:160px; height:160px; }
    .wrap{ margin:18px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Подтверждение оплаты терминалом</h1>
    <p class="lead">Отсканируйте QR-код на терминале, затем войдите в аккаунт, чтобы подтвердить оплату.</p>

    <div class="qr-wrap">
      <div>
        <div id="qrContainer" class="qr" title="QR для перехода на сайт">
          <!-- img вставляется сюда JS -->
        </div>
        <div class="small">Сканируйте QR или нажмите по нему, чтобы открыть сайт.</div>
      </div>

      <div style="flex:1; margin-left:12px;">
        <label for="terminalId">Terminal ID</label>
        <input id="terminalId" type="text" placeholder="например: TERMINAL_1234" />

        <label for="amount">Сумма (₽)</label>
        <input id="amount" type="number" step="0.01" placeholder="100.00" />

        <label for="userId">UserID</label>
        <input id="userId" type="text" placeholder="Ваш UserID" />

        <label for="password">Пароль</label>
        <input id="password" type="password" placeholder="Пароль" />

        <div class="row">
          <div class="col">
            <button id="btnLogin" class="primary">Подтвердить и отправить</button>
          </div>
          <div>
            <button id="btnClearCookie" class="ghost">Выйти (удалить cookie)</button>
          </div>
        </div>

        <div id="status" class="status"></div>
      </div>
    </div>

    <p style="margin-top:18px" class="small">Сайт запишет в Realtime Database терминала: mobile = "on", username = UserID, amount = сумма. Терминал увидит это и запустит списание.</p>
  </div>
</div>

<!-- ZXing QR (we will generate on the client) -->
<script>
// helper: create QR via canvas (no external libs)
function generateQrDataUrl(text, size){
  // use a simple in-browser QR generator via canvas + minimal encoder:
  // We'll use a lightweight JS implementation for QR generation (tiny)
  // To keep single-file, use a small implementation (based on kazuhiko arase qrcode-generator).
  // For brevity and reliability we will use a minimal emulation: generate via Google Chart? (deprecated)
  // Instead: create via canvas + using an embedded tiny QR lib.
  // For clarity here we'll implement using a small third-party function (compact).
  // Because including full encoder is long, we fallback to using the browser's fetch to a simple QR generator endpoint if available.
  // But offline: we can draw black/white placeholder until server side integration.
  // For simplicity in this example we create a canvas and draw a placeholder QR with the text inside.
  const canvas = document.createElement('canvas');
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,size,size);
  ctx.fillStyle = '#000';
  ctx.font = (size/12|0) + 'px monospace';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('QR', size/2, size/2 - 12);
  ctx.fillText(text, size/2, size/2 + 18);
  return canvas.toDataURL();
}

// small cookie helpers
function setCookie(name, value, days){
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  document.cookie = name + '=' + encodeURIComponent(value) + ';path=/;expires=' + d.toUTCString();
}
function getCookie(name){
  const pairs = document.cookie.split(';').map(s=>s.trim());
  for(const p of pairs){
    if(p.startsWith(name + '=')) return decodeURIComponent(p.split('=')[1]);
  }
  return null;
}
function eraseCookie(name){
  document.cookie = name + '=; Max-Age=0; path=/';
}

// Init: if saved user id — prefill
document.addEventListener('DOMContentLoaded', () => {
  const saved = getCookie('savedUserId');
  if(saved) document.getElementById('userId').value = saved;

  // build QR pointing to example.com/<terminalId>
  const tidInput = document.getElementById('terminalId');
  const amountInput = document.getElementById('amount');
  const qrContainer = document.getElementById('qrContainer');

  function buildQr(){
    const tid = (tidInput.value || 'TERMINAL_UNKNOWN').trim();
    const url = 'https://example.com/' + encodeURIComponent(tid);
    const size = Math.min(window.innerWidth, 480) * 0.6 | 0;
    const dataUrl = generateQrDataUrl(url, size || 220);
    qrContainer.innerHTML = '<img src="'+dataUrl+'" alt="QR">';
    // make clickable
    qrContainer.onclick = () => { window.open(url, '_blank') };
  }

  // initial QR
  buildQr();
  tidInput.addEventListener('input', buildQr);

  // login button
  document.getElementById('btnLogin').addEventListener('click', async () => {
    const userId = document.getElementById('userId').value.trim();
    const password = document.getElementById('password').value;
    const terminalId = document.getElementById('terminalId').value.trim();
    const amount = parseFloat(document.getElementById('amount').value) || 0;

    const status = document.getElementById('status');
    status.textContent = 'Отправляю запрос...';

    if(!userId || !password || !terminalId || !amount){
      status.textContent = 'Заполните Terminal ID, UserID, пароль и сумму.';
      return;
    }

    try {
      const resp = await fetch('/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ userId, password, terminalId, amount })
      });
      const j = await resp.json();
      if(resp.ok && j.success){
        status.textContent = 'Успешно: запрос отправлен. Терминал получит сигнал и начнёт оплату.';
        // save cookie
        setCookie('savedUserId', userId, 30);
      } else {
        status.textContent = 'Ошибка: ' + (j.error || 'неизвестная ошибка');
      }
    } catch(err){
      status.textContent = 'Ошибка сети: ' + err.message;
    }
  });

  document.getElementById('btnClearCookie').addEventListener('click', () => {
    eraseCookie('savedUserId');
    document.getElementById('userId').value = '';
    document.getElementById('status').textContent = 'Cookie удалены.';
  });
});
</script>
</body>
</html>
