<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>T-Bank Terminal — Подтвердить оплату</title>
  <style>
    :root{
      --bg:#fff; --card:#fff; --text:#111; --accent:#FFD400; --btn-text:#000;
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --bg:#000; --card:#111; --text:#fff; --accent:#FFD400; --btn-text:#000;
      }
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial,Helvetica,sans-serif}
    .wrap{max-width:520px;margin:28px auto;padding:18px}
    .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 6px 24px rgba(0,0,0,0.06)}
    h1{margin:0 0 8px;font-size:20px}
    p.small{margin:4px 0 12px;color:rgba(0,0,0,0.6)}
    .field{margin-bottom:12px}
    input[type="text"], input[type="password"]{width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;font-size:15px;background:transparent;color:var(--text)}
    button{background:var(--accent);border:none;padding:12px 16px;border-radius:10px;font-weight:600;cursor:pointer;color:var(--btn-text);font-size:15px}
    button.ghost{background:transparent;border:1px solid #ddd;color:var(--text)}
    .muted{color:rgba(0,0,0,0.6);font-size:14px}
    .status{margin-top:12px;padding:10px;border-radius:8px;background:rgba(0,0,0,0.03)}
  </style>

  <!-- Firebase (v9 modular) -->
  <script type="module">
    // --- ЗАМЕНИ на свою конфигурацию ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, child, get, query, orderByChild, equalTo, set, update, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "YOUR_APIKEY",
      authDomain: "YOUR_AUTHDOMAIN",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- UI helpers ---
    const $ = sel => document.querySelector(sel);
    const qs = sel => document.querySelectorAll(sel);

    // parse URL params
    const params = new URLSearchParams(location.search);
    const terminalId = params.get('id') || '';
    const amountParam = parseFloat(params.get('amount') || '0') || 0;
    const passedUsername = params.get('username') || null;

    // state
    let currentUsername = null;

    function showMessage(txt) {
      $('#status').innerText = txt;
    }

    // --- lookup user by username ---
    async function findUserByUsername(username) {
      const q = query(ref(db, 'users'), orderByChild('username'), equalTo(username));
      const snap = await get(q);
      if (!snap.exists()) return null;
      const childSnap = Object.values(snap.val())[0]; // first match
      const key = Object.keys(snap.val())[0];
      return { key, data: childSnap };
    }

    // --- check credentials (very simple check against users/<key>/password) ---
    async function verifyCredentials(username, password) {
      const u = await findUserByUsername(username);
      if (!u) return { ok:false, reason: "Пользователь не найден" };
      const stored = u.data.password;
      if (typeof stored === 'undefined') return { ok:false, reason: "Пароль не настроен на аккаунте" };
      if (String(stored) !== String(password)) return { ok:true, key: u.key, data: u.data };
      return { ok:false, reason: "Неправильный пароль" };
    }

    // --- when confirmed by user on site -> set terminals/<id>.mobile = "on" и username и amount ---
    async function confirmPayment(username, amount) {
      if (!terminalId) {
        showMessage("Ошибка: terminal id отсутствует в URL");
        return;
      }
      const termRef = ref(db, `terminals/${terminalId}`);
      await set(ref(db, `terminals/${terminalId}/username`), username);
      await set(ref(db, `terminals/${terminalId}/amount`), Number(amount));
      await set(ref(db, `terminals/${terminalId}/mobile`), "on");
      showMessage("Запрос отправлен терминалу. Ожидайте подтверждения...");
      // подписка для просмотра статуса (опционально)
      onValue(termRef, (snap) => {
        const val = snap.val() || {};
        if (val.status) {
          showMessage(`Статус: ${val.status}`);
        }
        if (val.mobile === "off" && val.status === "paid") {
          showMessage(`Оплата ${val.lastPayment?.amount || amount} ₽ проведена успешно.`);
        }
        if (val.mobile === "off" && val.status === "insufficient") {
          showMessage("У вас недостаточно средств.");
        }
      });
    }

    // --- UI init after DOM ready ---
    window.addEventListener('DOMContentLoaded', () => {
      $('#terminal').innerText = terminalId || '(не указан)';
      $('#amount').innerText = amountParam.toFixed(2) + ' ₽';

      if (passedUsername) {
        // сразу проверим баланс и покажем кнопку подтверждения, если хватает
        $('#loginForm').style.display = 'none';
        currentUsername = passedUsername;
        $('#userDisplay').innerText = currentUsername;
        $('#userBlock').style.display = 'block';
        // проверим достаточно ли средств
        findUserByUsername(currentUsername).then(u => {
          if (!u) {
            $('#checkMessage').innerText = 'Пользователь не найден';
            $('#confirmBtn').disabled = true;
            return;
          }
          const balance = parseFloat(u.data.balance) || 0;
          if (balance < amountParam) {
            $('#checkMessage').innerText = 'Недостаточно средств';
            $('#confirmBtn').disabled = true;
          } else {
            $('#checkMessage').innerText = `Достаточно средств: ${balance.toFixed(2)} ₽`;
            $('#confirmBtn').disabled = false;
          }
        });
      } else {
        // показать форму логина
        $('#userBlock').style.display = 'none';
        $('#loginForm').style.display = 'block';
      }

      $('#loginBtn').addEventListener('click', async (e) => {
        e.preventDefault();
        const username = $('#username').value.trim();
        const password = $('#password').value;
        if (!username || !password) {
          $('#loginError').innerText = 'Введите username и пароль';
          return;
        }
        $('#loginError').innerText = 'Проверка...';
        const res = await verifyCredentials(username, password);
        if (!res.ok) {
          $('#loginError').innerText = res.reason;
          return;
        }
        currentUsername = username;
        // запомним в localStorage чтобы не вводить каждый раз
        try { localStorage.setItem('tb_logged_username', username); } catch(e){}
        $('#loginForm').style.display = 'none';
        $('#userDisplay').innerText = username;
        $('#userBlock').style.display = 'block';

        // проверим баланс
        const balance = parseFloat(res.data.balance) || 0;
        if (balance < amountParam) {
          $('#checkMessage').innerText = 'Недостаточно средств';
          $('#confirmBtn').disabled = true;
        } else {
          $('#checkMessage').innerText = `Достаточно средств: ${balance.toFixed(2)} ₽`;
          $('#confirmBtn').disabled = false;
        }
      });

      $('#confirmBtn').addEventListener('click', async (e) => {
        if (!currentUsername) {
          $('#status').innerText = 'Сначала войдите';
          return;
        }
        $('#confirmBtn').disabled = true;
        $('#status').innerText = 'Отправка запроса...';
        await confirmPayment(currentUsername, amountParam);
      });

      // Если пользователь уже залогинен в localStorage, подставим username (UX)
      const stored = localStorage.getItem('tb_logged_username');
      if (stored && !passedUsername) {
        $('#username').value = stored;
      }
    });

  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Оплата — терминал <span id="terminal"></span></h1>
      <p class="muted">Сумма: <strong id="amount">0.00 ₽</strong></p>

      <div id="loginForm" style="display:none">
        <div class="field"><input id="username" placeholder="Username" type="text"></div>
        <div class="field"><input id="password" placeholder="Пароль" type="password"></div>
        <div style="display:flex;gap:10px">
          <button id="loginBtn">Войти</button>
          <button class="ghost" onclick="window.location.reload()">Очистить</button>
        </div>
        <div id="loginError" class="muted" style="margin-top:8px;color:red"></div>
      </div>

      <div id="userBlock" style="display:none">
        <p>Войдены как: <strong id="userDisplay"></strong></p>
        <p id="checkMessage" class="muted"></p>
        <div style="margin-top:12px">
          <button id="confirmBtn" disabled>Подтвердить оплату</button>
        </div>
      </div>

      <div class="status" id="status" style="margin-top:14px">Статус: ожидание действий</div>
    </div>
  </div>
</body>
</html>
