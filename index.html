<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>T-Bank — управление Value терминала</title>
  <style>
    :root{
      --bg:#f7f8fb;--card:#fff;--text:#111;--muted:#666;--accent:#0066cc;--danger:#c62828;
    }
    body{margin:0;font-family:Inter,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:900px;margin:20px auto;padding:16px}
    .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    h1{margin:0 0 8px;font-size:20px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px}
    input[type=text], input[type=number] {padding:10px;border-radius:8px;border:1px solid #e8e8e8;font-size:14px}
    button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid rgba(0,102,204,0.12);color:var(--accent);padding:8px 12px;border-radius:8px}
    .small{font-size:13px}
    .hidden{display:none}
    pre{background:#f4f6fb;padding:10px;border-radius:8px;overflow:auto}
    .err{color:var(--danger)}
  </style>
  <!-- Firebase v9 modular -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, set, update, onValue, off } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ====== ЗАМЕНИ НА СВОИ ПАРАМЕТРЫ ======
    const firebaseConfig = {
      apiKey: "REPLACE_API_KEY",
      authDomain: "REPLACE_AUTH_DOMAIN",
      databaseURL: "https://REPLACE_PROJECT.firebaseio.com",
      projectId: "REPLACE_PROJECT_ID",
      storageBucket: "REPLACE_BUCKET.appspot.com",
      messagingSenderId: "REPLACE_SENDER",
      appId: "REPLACE_APPID"
    };
    // =======================================
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- DOM ---
    const $$ = id => document.getElementById(id);
    const inputTid = $$('inputTid');
    const btnLoadTid = $$('btnLoadTid');
    const tidDisplay = $$('tidDisplay');
    const amountDisplay = $$('amountDisplay');
    const termRaw = $$('termRaw');
    const valueInput = $$('valueInput');
    const btnWrite = $$('btnWrite');
    const btnClear = $$('btnClear');
    const info = $$('info');
    const terminalHint = $$('terminalHint');

    let currentTid = null;
    let termRef = null;

    function showInfo(txt, err=false){
      info.textContent = txt;
      info.style.color = err ? 'var(--danger)' : 'var(--muted)';
    }

    function normalizeTerminalValue(obj){
      // пытаемся найти поле, содержащее сумму: Value, value, ValueAmount, amount, Value (регистронезависимо)
      if (!obj) return null;
      // direct common keys
      const keys = Object.keys(obj);
      // prioritize exact keys
      const candidates = ['Value','value','amount','ValueAmount','ValueAmt','ValueAmount','Value_val','ValueVal'];
      for (const k of candidates){
        if (k in obj) return {key:k, val: obj[k]};
      }
      // fallback: search for numeric-ish fields
      for (const k of keys){
        const v = obj[k];
        if (v === null || v === undefined) continue;
        // numeric or numeric string
        if (typeof v === 'number') return {key:k, val:v};
        if (typeof v === 'string' && v.trim() !== '' && !isNaN(Number(v))) return {key:k, val: Number(v)};
      }
      return null;
    }

    function attachListener(tid){
      // detach old
      if (termRef) {
        try { off(termRef); } catch(e){}
        termRef = null;
      }
      currentTid = tid;
      tidDisplay.textContent = tid;
      terminalHint.textContent = 'Подключение к терминалу...';
      termRef = ref(db, 'terminals/' + tid);
      onValue(termRef, snap => {
        const val = snap.val();
        if (!val) {
          terminalHint.textContent = 'Терминал не найден в базе.';
          amountDisplay.textContent = '—';
          termRaw.textContent = 'null';
          showInfo('Терминал отсутствует или путь неверный', true);
          return;
        }
        // show raw snapshot
        termRaw.textContent = JSON.stringify(val, null, 2);
        // try to find Value-like field
        const found = normalizeTerminalValue(val);
        if (found) {
          amountDisplay.textContent = Number(found.val).toFixed(2);
          showInfo(`Полевой ключ: ${found.key}`);
        } else {
          amountDisplay.textContent = '—';
          showInfo('Поле Value (или эквивалент) не найдено в терминале');
        }
        terminalHint.textContent = 'Терминал подключён и слушается (live updates).';
      }, err => {
        terminalHint.textContent = 'Ошибка чтения терминала: ' + err.message;
        termRaw.textContent = '';
        amountDisplay.textContent = '—';
        showInfo('Ошибка чтения терминала: ' + err.message, true);
      });
    }

    // извлекаем id из url ?id=...
    const params = new URLSearchParams(location.search);
    const urlTid = (params.get('id') || '').trim();
    if (urlTid) {
      inputTid.value = urlTid;
      attachListener(urlTid);
    } else {
      terminalHint.textContent = 'ID терминала не передан в URL. Введите вручную и нажмите "Загрузить".';
    }

    btnLoadTid.addEventListener('click', () => {
      const tid = inputTid.value.trim();
      if (!tid) { alert('Введите ID терминала'); return; }
      attachListener(tid);
    });

    btnWrite.addEventListener('click', async () => {
      if (!currentTid) { alert('Сначала укажите ID терминала'); return; }
      const v = valueInput.value.trim();
      if (v === '') { alert('Введите число для записи в Value'); return; }
      const num = Number(v.replace(',', '.'));
      if (isNaN(num)) { alert('Неверное число'); return; }
      showInfo('Запись Value в базу...');
      try {
        // записываем именно в поле "Value" как число
        const p = 'terminals/' + currentTid + '/Value';
        await set(ref(db, p), num);
        showInfo(`Успешно записано в ${p}: ${num}`);
      } catch (e) {
        console.error(e);
        showInfo('Ошибка записи: ' + e.message, true);
      }
    });

    btnClear.addEventListener('click', async () => {
      if (!currentTid) { alert('Сначала укажите ID терминала'); return; }
      if (!confirm('Удалить поле terminals/' + currentTid + '/Value ?')) return;
      try {
        // удаляем поле Value (set null)
        const p = 'terminals/' + currentTid + '/Value';
        await set(ref(db, p), null);
        showInfo('Поле Value удалено');
      } catch (e) {
        console.error(e);
        showInfo('Ошибка при удалении: ' + e.message, true);
      }
    });

    // show initial info
    showInfo('Готово. Подключите ID терминала и используйте запись Value.');
  </script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Прогрузка Value для терминала</h1>
      <p id="terminalHint" class="muted">Инициализация...</p>

      <div class="row" style="margin-top:12px">
        <input id="inputTid" type="text" placeholder="ID терминала (или ?id=... в URL)" style="flex:1" />
        <button id="btnLoadTid" class="btn-ghost">Загрузить</button>
      </div>

      <div id="terminalArea" style="margin-top:16px">
        <div class="small muted">Терминал</div>
        <div id="tidDisplay" style="font-weight:700;margin-bottom:8px">—</div>

        <div class="small muted">Текущее значение (Value / amount / value)</div>
        <div id="amountDisplay" style="font-size:28px;font-weight:700;margin-bottom:8px">—</div>

        <div class="row" style="margin-top:8px;align-items:center">
          <input id="valueInput" type="text" placeholder="Введите сумму, которую нужно записать в Value" />
          <button id="btnWrite">Записать Value</button>
          <button id="btnClear" class="btn-ghost">Удалить Value</button>
        </div>

        <div style="margin-top:12px">
          <div class="small muted">Полный узел терминала:</div>
          <pre id="termRaw" style="height:200px">—</pre>
        </div>

        <div style="margin-top:8px" class="small muted" id="info">—</div>
      </div>
    </div>
  </div>
</body>
</html>
