<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>T-Bank Terminal — Подтвердить оплату</title>
  <style>
    :root{
      --bg:#fff; --card:#fff; --text:#111; --accent:#FFD400; --btn-text:#000;
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --bg:#000; --card:#111; --text:#fff; --accent:#FFD400; --btn-text:#000;
      }
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial,Helvetica,sans-serif}
    .wrap{max-width:520px;margin:28px auto;padding:18px}
    .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 6px 24px rgba(0,0,0,0.06)}
    h1{margin:0 0 8px;font-size:20px}
    p.small{margin:4px 0 12px;color:rgba(0,0,0,0.6)}
    .field{margin-bottom:12px}
    input[type="text"], input[type="password"]{width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;font-size:15px;background:transparent;color:var(--text)}
    button{background:var(--accent);border:none;padding:12px 16px;border-radius:10px;font-weight:600;cursor:pointer;color:var(--btn-text);font-size:15px}
    button.ghost{background:transparent;border:1px solid #ddd;color:var(--text)}
    .muted{color:rgba(0,0,0,0.6);font-size:14px}
    .status{margin-top:12px;padding:10px;border-radius:8px;background:rgba(0,0,0,0.03)}
    .small-note { font-size:13px; color:rgba(0,0,0,0.5); margin-top:8px; }
    .center { text-align:center; }
  </style>

  <!-- Firebase (v9 modular) -->
  <script type="module">
    // --- ЗАМЕНИ на свою конфигурацию ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getDatabase, ref, get, query, orderByChild, equalTo,
      set, update, onValue
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
  apiKey: "AIzaSyDnORXUTdAoZ3RDkt439YNCCllggSUPejM",
  authDomain: "t-bank-emu.firebaseapp.com",
  databaseURL: "https://t-bank-emu-default-rtdb.firebaseio.com",
  projectId: "t-bank-emu",
  storageBucket: "t-bank-emu.firebasestorage.app",
  messagingSenderId: "230284086962",
  appId: "1:230284086962:web:e5e61a82a3c31eb6f9c3ab"
};
    // Инициализация Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- UI helpers ---
    const $ = sel => document.querySelector(sel);
    const qs = sel => document.querySelectorAll(sel);

    function setStatus(txt, isError = false) {
      const el = $('#status');
      el.innerText = txt;
      el.style.color = isError ? 'crimson' : '';
    }

    function showMessage(txt) { setStatus(txt, false); }
    function showError(txt) { setStatus(txt, true); }

    // --- parse URL params ---
    const params = new URLSearchParams(location.search);
    const terminalId = params.get('id') || '';
    const amountParam = parseFloat(params.get('amount') || '0') || 0;
    const passedUsername = params.get('username') || null;

    // --- state ---
    let currentUsername = null;
    let terminalUnsub = null; // для отписки onValue

    // --- network helper: timeout wrapper ---
    function withTimeout(promise, ms = 7000) {
      return Promise.race([
        promise,
        new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), ms))
      ]);
    }

    // --- lookup user by username (safe, with timeout & error handling) ---
    async function findUserByUsername(username) {
      try {
        const q = query(ref(db, 'users'), orderByChild('username'), equalTo(username));
        const snap = await withTimeout(get(q), 8000);
        if (!snap.exists()) return null;
        const val = snap.val();
        // берем первый найденный
        const key = Object.keys(val)[0];
        const data = val[key];
        return { key, data };
      } catch (err) {
        console.error('findUserByUsername error', err);
        throw err;
      }
    }

    // --- verify credentials (very simple; compares with stored password) ---
    async function verifyCredentials(username, password) {
      try {
        const u = await findUserByUsername(username);
        if (!u) return { ok:false, reason: "Пользователь не найден" };
        async function verifyCredentials(username, password) {
  try {
    const u = await findUserByUsername(username);
    if (!u) return { ok: false, reason: "Пользователь не найден" };

    const stored = u.data.password;
    if (typeof stored === 'undefined') return { ok: false, reason: "Пароль не настроен на аккаунте" };

    // Нормализуем: убираем пробелы вокруг и сравниваем строки
    const sStored = String(stored).trim();
    const sPass = String(password).trim();

    if (sStored === sPass) {
      return { ok: true, key: u.key, data: u.data };
    } else {
      return { ok: false, reason: "Неправильный пароль" };
    }
  } catch (err) {
    console.error('verifyCredentials error', err);
    return { ok: false, reason: 'Ошибка сети/сервер: ' + (err.message || err) };
  }
}

    // --- confirmPayment: atomically обновляем терминал и подписываемся на результат ---
    async function confirmPayment(username, amount) {
      if (!terminalId) {
        showError("Ошибка: terminal id отсутствует в URL");
        return;
      }

      const termPath = `terminals/${terminalId}`;
      const termRef = ref(db, termPath);

      try {
        // Обновляем запись терминала: mobile=on, username, amount, status=pending
        await withTimeout(update(ref(db, termPath), {
          username: username,
          amount: Number(amount),
          mobile: "on",
          status: "pending",
          lastUpdate: Date.now()
        }), 7000);

        showMessage("Запрос отправлен терминалу. Ожидайте подтверждения...");

        // очистим предыдущую подписку если была
        if (typeof terminalUnsub === 'function') {
          terminalUnsub();
          terminalUnsub = null;
        }

        // подпишемся на терминал и будем слушать status/mobile
        terminalUnsub = onValue(termRef, (snap) => {
          const val = snap.val() || {};
          const mobile = val.mobile;
          const status = val.status;
          // показываем текущий статус
          if (status) showMessage(`Статус: ${status}`);
          else showMessage(`Статус: ожидание`);

          // Если терминал установил mobile=off и status сообщает результат — завершаем
          if (mobile === "off") {
            if (status === 'paid') {
              const lastAmt = val.lastPayment?.amount ?? amount;
              showMessage(`Оплата ${Number(lastAmt).toFixed(2)} ₽ проведена успешно.`);
            } else if (status === 'insufficient') {
              showError("У вас недостаточно средств.");
            } else {
              // другие статусы
              showMessage(`Статус терминала: ${status || 'неизвестен'}`);
            }
            // отписываемся (чтобы не висела "вечная" подписка)
            try { terminalUnsub(); } catch(e) {}
            terminalUnsub = null;
          }
        }, (err) => {
          console.error('onValue error', err);
          showError('Ошибка подписки на терминал: ' + (err.message || err));
          // отписать если нужно
          if (typeof terminalUnsub === 'function') { try { terminalUnsub(); } catch(e){} terminalUnsub = null; }
        });

      } catch (err) {
        console.error('confirmPayment error', err);
        showError('Ошибка отправки запроса: ' + (err.message || err));
      }
    }

    // --- DOM ready init ---
    window.addEventListener('DOMContentLoaded', () => {
      $('#terminal').innerText = terminalId || '(не указан)';
      $('#amount').innerText = amountParam.toFixed(2) + ' ₽';

      // Если пришёл username в URL (например: ?id=TERMINAL&username=dima_ko)
      if (passedUsername) {
        $('#loginForm').style.display = 'none';
        currentUsername = passedUsername;
        $('#userDisplay').innerText = currentUsername;
        $('#userBlock').style.display = 'block';
        setStatus('Проверяем баланс...');
        // проверим баланс с таймаутом
        findUserByUsername(currentUsername).then(u => {
          if (!u) {
            $('#checkMessage').innerText = 'Пользователь не найден';
            $('#confirmBtn').disabled = true;
            showError('Пользователь не найден');
            return;
          }
          const balance = parseFloat(u.data.balance) || 0;
          if (balance < amountParam) {
            $('#checkMessage').innerText = 'Недостаточно средств';
            $('#confirmBtn').disabled = true;
            showError('Недостаточно средств');
          } else {
            $('#checkMessage').innerText = `Достаточно средств: ${balance.toFixed(2)} ₽`;
            $('#confirmBtn').disabled = false;
            showMessage('Готово к подтверждению');
          }
        }).catch(err => {
          console.error(err);
          $('#checkMessage').innerText = 'Ошибка проверки';
          $('#confirmBtn').disabled = true;
          showError('Ошибка проверки пользователя: ' + (err.message || err));
        });
      } else {
        // показать форму логина
        $('#userBlock').style.display = 'none';
        $('#loginForm').style.display = 'block';
      }

      // Автовставка username из localStorage (если есть)
      const stored = localStorage.getItem('tb_logged_username');
      if (stored && !passedUsername) {
        $('#username').value = stored;
      }

      // Login button handler
      $('#loginBtn').addEventListener('click', async (e) => {
        e.preventDefault();
        $('#loginError').innerText = '';
        const username = $('#username').value.trim();
        const password = $('#password').value;
        if (!username || !password) {
          $('#loginError').innerText = 'Введите username и пароль';
          return;
        }
        $('#loginError').innerText = 'Проверка...';
        try {
          const res = await verifyCredentials(username, password);
          if (!res.ok) {
            $('#loginError').innerText = res.reason;
            showError(res.reason);
            return;
          }
          currentUsername = username;
          // запомним username (но не пароль) в localStorage
          try { localStorage.setItem('tb_logged_username', username); } catch(e){}
          $('#loginForm').style.display = 'none';
          $('#userDisplay').innerText = username;
          $('#userBlock').style.display = 'block';

          // проверим баланс
          const balance = parseFloat(res.data.balance) || 0;
          if (balance < amountParam) {
            $('#checkMessage').innerText = 'Недостаточно средств';
            $('#confirmBtn').disabled = true;
            showError('Недостаточно средств');
          } else {
            $('#checkMessage').innerText = `Достаточно средств: ${balance.toFixed(2)} ₽`;
            $('#confirmBtn').disabled = false;
            showMessage('Готово к подтверждению');
          }
        } catch (err) {
          console.error(err);
          $('#loginError').innerText = 'Ошибка сети/сервер: ' + (err.message || err);
          showError('Ошибка сети/сервер: ' + (err.message || err));
        }
      });

      // Confirm pay handler
      $('#confirmBtn').addEventListener('click', async (e) => {
        if (!currentUsername) {
          showError('Сначала войдите');
          return;
        }
        $('#confirmBtn').disabled = true;
        showMessage('Отправка запроса...');
        await confirmPayment(currentUsername, amountParam);
        // кнопка остаётся disabled, статус будет обновлён подпиской
      });

      // Clear button resets local UX (not the db)
      $('#clearBtn')?.addEventListener('click', () => {
        try { localStorage.removeItem('tb_logged_username'); } catch(e){}
        $('#username').value = '';
        $('#password').value = '';
        $('#loginError').innerText = '';
        showMessage('Очистили локальные данные');
      });

    });

    // Отписка при выгрузке страницы
    window.addEventListener('beforeunload', () => {
      if (typeof terminalUnsub === 'function') {
        try { terminalUnsub(); } catch(e){}
        terminalUnsub = null;
      }
    });

  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Оплата — терминал <span id="terminal"></span></h1>
      <p class="muted">Сумма: <strong id="amount">0.00 ₽</strong></p>

      <div id="loginForm" style="display:none">
        <div class="field"><input id="username" placeholder="Username" type="text" autocomplete="username"></div>
        <div class="field"><input id="password" placeholder="Пароль" type="password" autocomplete="current-password"></div>
        <div style="display:flex;gap:10px">
          <button id="loginBtn">Войти</button>
          <button id="clearBtn" class="ghost" type="button">Очистить</button>
        </div>
        <div id="loginError" class="muted" style="margin-top:8px;color:red"></div>
        <div class="small-note">Username и пароль проверяются в Realtime Database (для прототипа).</div>
      </div>

      <div id="userBlock" style="display:none">
        <p>Войдены как: <strong id="userDisplay"></strong></p>
        <p id="checkMessage" class="muted"></p>
        <div style="margin-top:12px">
          <button id="confirmBtn" disabled>Подтвердить оплату</button>
        </div>
      </div>

      <div class="status" id="status" style="margin-top:14px">Статус: ожидание действий</div>
      <p class="center small-note" style="margin-top:8px">Если сайт долго не отвечает — проверьте firebaseConfig, правила Realtime Database и доступность интернета.</p>
    </div>
  </div>
</body>
</html>
