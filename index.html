<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Confirm payment — Terminal</title>
<style>
  :root{
    --yellow: #FFD400;
    --dark-yellow: #E6BB00;
    --bg: #ffffff;
    --text: #111;
    --card: #fff9e6;
    --btn-text: #111;
  }
  @media (prefers-color-scheme: dark) {
    :root{
      --bg: #000;
      --text: #fff;
      --card: #0a0a0a;
      --yellow: #FFD400;
      --dark-yellow: #E6BB00;
      --btn-text: #000;
    }
  }
  html,body{height:100%;margin:0;font-family:Inter,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:760px;margin:28px auto;padding:18px}
  .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  h1{margin:0 0 8px;font-size:20px}
  label{display:block;margin-top:12px;font-size:13px}
  input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:var(--text)}
  .row{display:flex;gap:10px;margin-top:12px}
  button.primary{padding:12px 16px;border-radius:10px;border:none;background:linear-gradient(180deg,var(--yellow),var(--dark-yellow));color:var(--btn-text);font-weight:600;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(0,0,0,0.08);padding:10px;border-radius:8px;cursor:pointer}
  .muted{color:rgba(0,0,0,0.55);font-size:13px}
  .center{display:flex;align-items:center;gap:12px}
  .qr{width:160px;height:160px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;border:1px dashed rgba(0,0,0,0.06)}
  .hidden{display:none}
  .status{margin-top:10px;font-size:14px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="mainCard">
      <h1>Оплата терминалом</h1>
      <div id="intro" class="muted">Сканируйте QR на терминале — вы попали на эту страницу. Проверьте сумму и выполните вход.</div>

      <div style="display:flex;gap:18px;margin-top:16px;align-items:flex-start">
        <div>
          <div id="qrBox" class="qr" title="QR on terminal">
            <div id="qrText" class="muted">TERMINAL</div>
          </div>
          <div class="muted" style="text-align:center;margin-top:8px">Терминал: <span id="qrTid">—</span></div>
        </div>

        <div style="flex:1">
          <!-- LOGIN FORM -->
          <div id="loginStage">
            <label>Terminal ID</label>
            <input id="terminalId" placeholder="TERMINAL_..." />

            <label>Сумма (₽)</label>
            <input id="amount" type="number" step="0.01" placeholder="100.00" />

            <label>Username</label>
            <input id="username" placeholder="Ваш логин" />

            <label>Пароль</label>
            <input id="password" type="password" placeholder="Пароль" />

            <div class="row">
              <button id="btnAuth" class="primary">Войти</button>
              <button id="btnFillCookie" class="ghost">Сохранённый логин</button>
            </div>
            <div id="loginStatus" class="status"></div>
          </div>

          <!-- CONFIRM STAGE -->
          <div id="confirmStage" class="hidden">
            <div class="muted">Вы вошли как <strong id="loggedUser"></strong></div>
            <div style="margin-top:12px">
              <div>Терминал: <strong id="confTid"></strong></div>
              <div>Сумма: <strong id="confAmount"></strong> ₽</div>
            </div>
            <div class="row" style="margin-top:12px">
              <button id="btnConfirm" class="primary">Подтвердить оплату</button>
              <button id="btnLogout" class="ghost">Выйти</button>
            </div>
            <div id="confirmStatus" class="status"></div>
          </div>

          <!-- RESULT STAGE -->
          <div id="resultStage" class="hidden">
            <div id="resultText" style="font-weight:700;font-size:18px;margin-top:6px"></div>
            <div class="muted" style="margin-top:8px">Вы будете возвращены через несколько секунд...</div>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
/* --- cookie helpers --- */
function setCookie(name, value, days=30){ const d=new Date(); d.setTime(d.getTime()+days*86400000); document.cookie = name+'='+encodeURIComponent(value)+';path=/;expires='+d.toUTCString(); }
function getCookie(name){ const pairs=document.cookie.split(';').map(s=>s.trim()); for(const p of pairs) if(p.startsWith(name+'=')) return decodeURIComponent(p.split('=').slice(1).join('=')); return null; }
function eraseCookie(name){ document.cookie = name+'=; Max-Age=0; path=/'; }

/* --- utility to parse terminalId and amount from URL path or query --- */
function getTerminalFromUrl(){
  // path like /TERMINAL_123 or trailing slash
  const path = window.location.pathname || '/';
  let tid = null;
  const p = path.replace(/^\/+|\/+$/g,'');
  if(p) tid = decodeURIComponent(p);
  // query ?amount=...
  const qs = new URLSearchParams(window.location.search);
  const amount = qs.get('amount') || '';
  return { terminalId: tid, amount: amount };
}

/* --- UI refs --- */
const terminalIdInput = document.getElementById('terminalId');
const amountInput = document.getElementById('amount');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const btnAuth = document.getElementById('btnAuth');
const btnFillCookie = document.getElementById('btnFillCookie');
const loginStatus = document.getElementById('loginStatus');
const qrText = document.getElementById('qrText');
const qrTid = document.getElementById('qrTid');

const loginStage = document.getElementById('loginStage');
const confirmStage = document.getElementById('confirmStage');
const resultStage = document.getElementById('resultStage');
const loggedUser = document.getElementById('loggedUser');
const confTid = document.getElementById('confTid');
const confAmount = document.getElementById('confAmount');
const btnConfirm = document.getElementById('btnConfirm');
const btnLogout = document.getElementById('btnLogout');
const confirmStatus = document.getElementById('confirmStatus');
const resultText = document.getElementById('resultText');

let lastAuth = null; // { userId, username }

/* --- init --- */
document.addEventListener('DOMContentLoaded', () => {
  const info = getTerminalFromUrl();
  if(info.terminalId){
    terminalIdInput.value = info.terminalId;
    qrText.textContent = info.terminalId;
    qrTid.textContent = info.terminalId;
    confTid.textContent = info.terminalId;
  } else {
    qrText.textContent = 'NO-TID';
    qrTid.textContent = '—';
  }
  if(info.amount) { amountInput.value = info.amount; confAmount.textContent = info.amount; }

  // if cookie with username exists, fill
  const saved = getCookie('savedUsername');
  if(saved) usernameInput.value = saved;
});

/* --- AUTH (login) --- */
btnAuth.addEventListener('click', async () => {
  loginStatus.textContent = 'Проверка...';
  const username = usernameInput.value.trim();
  const password = passwordInput.value;
  const terminalId = terminalIdInput.value.trim();
  const amount = parseFloat(amountInput.value || '0') || 0;
  if(!username || !password || !terminalId || amount<=0){
    loginStatus.textContent = 'Заполните Terminal, сумму, username и пароль.';
    return;
  }

  try {
    const resp = await fetch('/auth', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password }) });
    const json = await resp.json();
    if(resp.ok && json.success){
      // success
      lastAuth = { userId: json.userId, username: username };
      setCookie('savedUsername', username, 30);
      loginStatus.textContent = 'Успешно. Перенаправляем на подтверждение...';
      showConfirmStage(terminalId, amount, username);
    } else {
      loginStatus.textContent = 'Ошибка входа: ' + (json.error || 'неверный логин/пароль');
    }
  } catch(e){
    loginStatus.textContent = 'Ошибка сети: ' + e.message;
  }
});

btnFillCookie.addEventListener('click', ()=> {
  const saved = getCookie('savedUsername');
  if(saved) { usernameInput.value = saved; loginStatus.textContent = 'Вставлен сохранённый логин.'; } else loginStatus.textContent = 'Сохранённого логина нет.';
});

/* --- show confirm --- */
function showConfirmStage(tid, amount, username){
  loginStage.classList.add('hidden');
  confirmStage.classList.remove('hidden');
  loggedUser.textContent = username;
  confTid.textContent = tid;
  confAmount.textContent = (''+amount);
}

/* --- confirm action --- */
btnConfirm.addEventListener('click', async () => {
  confirmStatus.textContent = 'Отправка подтверждения на сервер...';
  const tid = terminalIdInput.value.trim();
  const amount = parseFloat(amountInput.value || '0') || 0;
  if(!lastAuth || !tid || amount <= 0){
    confirmStatus.textContent = 'Нет данных (возможно сессия устарела).';
    return;
  }
  const payload = { terminalId: tid, userId: lastAuth.userId, username: lastAuth.username, amount };
  try {
    const resp = await fetch('/confirm', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const json = await resp.json();
    if(resp.ok && json.success){
      confirmStatus.textContent = 'Запрос принят. Терминал получит сигнал и начнёт оплату.';
      // show result (fake)
      confirmStage.classList.add('hidden');
      resultStage.classList.remove('hidden');
      resultText.textContent = `Оплата ${amount.toFixed(2)} ₽ успешно инициирована.`;
      // optionally redirect or close after delay
      setTimeout(()=>{ window.location.href = '/'; }, 4000);
    } else {
      confirmStatus.textContent = 'Ошибка: ' + (json.error || 'server error');
    }
  } catch(e){
    confirmStatus.textContent = 'Ошибка сети: ' + e.message;
  }
});

/* --- logout --- */
btnLogout.addEventListener('click', ()=>{ eraseCookie('savedUsername'); lastAuth = null; confirmStage.classList.add('hidden'); loginStage.classList.remove('hidden'); loginStatus.textContent='Выход выполнен.'; });

</script>
</body>
</html>
